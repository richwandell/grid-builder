{"version":3,"sources":["../../src/server/WebSocketServer.es6"],"names":["WsServer","require","server","http","WebSocketServer","log","restServer","connections","httpServer","autoAcceptConnections","on","request","onRequest","e","error","message","connection","accept","origin","push","onConnectionMessage","reasonCode","description","Date","remoteAddress","sendUTF","JSON","stringify","type","console","utf8Data","binaryData","length","sendBytes"],"mappings":";;;;;;;;;;AAAA,IAAMA,WAAWC,QAAQ,WAAR,EAAqBC,MAAtC;AACA,IAAMC,OAAOF,QAAQ,MAAR,CAAb;;IAGMG,e;AAEF,6BAAYC,GAAZ,EAAsBC,UAAtB,EAA6C;AAAA;;AACzC,aAAKD,GAAL,GAAWA,GAAX;AACA,aAAKE,WAAL,GAAmB,EAAnB;AACA,aAAKD,UAAL,GAAkBA,UAAlB;AACH;;;;sCAEY;AAAA;;AACT,iBAAKJ,MAAL,GAAc,IAAIF,QAAJ,CAAa;AACvBQ,4BAAY,KAAKF,UADM;AAEvBG,uCAAuB;AAFA,aAAb,CAAd;;AAKA,iBAAKP,MAAL,CAAYQ,EAAZ,CAAe,SAAf,EAA0B,UAACC,OAAD,EAAa;AACnC,oBAAI;AACA,0BAAKC,SAAL,CAAeD,OAAf;AACH,iBAFD,CAEC,OAAME,CAAN,EAAQ;AACL,0BAAKR,GAAL,CAASS,KAAT,CAAeD,EAAEE,OAAjB;AACH;AACJ,aAND;AAOH;;;kCAESJ,O,EAAS;AAAA;;AACf,gBAAIK,aAAaL,QAAQM,MAAR,CAAe,eAAf,EAAgCN,QAAQO,MAAxC,CAAjB;AACA,iBAAKX,WAAL,CAAiBY,IAAjB,CAAsBH,UAAtB;AACA,iBAAKX,GAAL,CAASA,GAAT,CAAa,qBAAb;;AAEAW,uBAAWN,EAAX,CAAc,SAAd,EAAyB,UAACK,OAAD,EAAa;AAClC,uBAAKK,mBAAL,CAAyBJ,UAAzB,EAAqCD,OAArC;AACH,aAFD;;AAIAC,uBAAWN,EAAX,CAAc,OAAd,EAAuB,UAACW,UAAD,EAAaC,WAAb,EAA6B;AAChD,uBAAKjB,GAAL,CAASA,GAAT,CAAc,IAAIkB,IAAJ,EAAD,GAAe,QAAf,GAA0BP,WAAWQ,aAArC,GAAqD,gBAAlE;AACH,aAFD;;AAIAR,uBAAWS,OAAX,CAAmBC,KAAKC,SAAL,CAAe,EAAC,UAAU,IAAX,EAAf,CAAnB;AACH;;;4CAEmBX,U,EAAYD,O,EAAS;AACrC,gBAAIA,QAAQa,IAAR,KAAiB,MAArB,EAA6B;AACzBC,wBAAQxB,GAAR,CAAY,uBAAuBU,QAAQe,QAA3C;AACAd,2BAAWS,OAAX,CAAmBV,QAAQe,QAA3B;AACH,aAHD,MAIK,IAAIf,QAAQa,IAAR,KAAiB,QAArB,EAA+B;AAChCC,wBAAQxB,GAAR,CAAY,gCAAgCU,QAAQgB,UAAR,CAAmBC,MAAnD,GAA4D,QAAxE;AACAhB,2BAAWiB,SAAX,CAAqBlB,QAAQgB,UAA7B;AACH;AACJ;;;;;;kBAGU3B,e","file":"WebSocketServer.js","sourcesContent":["const WsServer = require('websocket').server;\nconst http = require('http');\n\n\nclass WebSocketServer {\n\n    constructor(log: Log, restServer: RestServer){\n        this.log = log;\n        this.connections = [];\n        this.restServer = restServer;\n    }\n\n    startServer(){\n        this.server = new WsServer({\n            httpServer: this.restServer,\n            autoAcceptConnections: false\n        });\n\n        this.server.on('request', (request) => {\n            try {\n                this.onRequest(request);\n            }catch(e){\n                this.log.error(e.message);\n            }\n        });\n    }\n\n    onRequest(request) {\n        let connection = request.accept('echo-protocol', request.origin);\n        this.connections.push(connection);\n        this.log.log(\"Connection Accepted\");\n\n        connection.on('message', (message) => {\n            this.onConnectionMessage(connection, message);\n        });\n\n        connection.on('close', (reasonCode, description) => {\n            this.log.log((new Date()) + ' Peer ' + connection.remoteAddress + ' disconnected.');\n        });\n\n        connection.sendUTF(JSON.stringify({'action': 'HI'}));\n    }\n\n    onConnectionMessage(connection, message) {\n        if (message.type === 'utf8') {\n            console.log('Received Message: ' + message.utf8Data);\n            connection.sendUTF(message.utf8Data);\n        }\n        else if (message.type === 'binary') {\n            console.log('Received Binary Message of ' + message.binaryData.length + ' bytes');\n            connection.sendBytes(message.binaryData);\n        }\n    }\n}\n\nexport default WebSocketServer;"]}