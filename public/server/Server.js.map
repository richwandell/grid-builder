{"version":3,"sources":["../../src/server/Server.es6"],"names":["numCPUs","require","cpus","length","debug","process","execArgv","indexOf","cluster","pjson","Server","data","send","onWorkerMessage","numWorker","workers","runMainWorker","run","isMaster","i","createWorker","w","fork","on","message","push","console","log","pid","socket","onMainMessage","worker","code","signal","exitedAfterDisconnect","upnp","startBroadcast","rest","createServer","listen","builder_ws_port","getLog","getServer","startServer","builder_rest_port"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;;;;;AACA,IAAMA,UAAUC,QAAQ,IAAR,EAAcC,IAAd,GAAqBC,MAArC;AACA,IAAMC,QAAQC,QAAQC,QAAR,CAAiBC,OAAjB,CAAyB,SAAzB,IAAsC,CAAC,CAAvC,IAA4CF,QAAQC,QAAR,CAAiBC,OAAjB,CAAyB,aAAzB,IAA0C,CAAC,CAArG;AACA,IAAMC,UAAUP,QAAQ,SAAR,CAAhB;AACA,IAAMQ,QAAQR,QAAQ,oBAAR,CAAd;;IAEMS,M;;;6BAEGC,I,EAAK;AACN,gBAAG,CAAC,KAAKP,KAAT,EAAgB;AACZC,wBAAQO,IAAR,CAAaD,IAAb;AACH,aAFD,MAEK;AACD,qBAAKE,eAAL,CAAqBF,IAArB;AACH;AACJ;;;AAED,oBAAYG,SAAZ,EAA+BV,KAA/B,EAA+C;AAAA;;AAC3C,aAAKA,KAAL,GAAaA,KAAb;AACA,aAAKW,OAAL,GAAe,EAAf;;AAEA,YAAGX,KAAH,EAAS;AACL,iBAAKY,aAAL;AACA,iBAAKC,GAAL;AACH,SAHD,MAGM,IAAGT,QAAQU,QAAX,EAAoB;AACtB,iBAAKF,aAAL;;AAEA,iBAAK,IAAIG,IAAI,CAAb,EAAgBA,IAAIL,SAApB,EAA+BK,GAA/B,EAAoC;AAChC,qBAAKC,YAAL;AACH;AACJ,SANK,MAMC;AACH,iBAAKH,GAAL;AACH;AACJ;;;;uCAEa;AAAA;;AACV,gBAAII,IAAIb,QAAQc,IAAR,EAAR;AACAD,cAAEE,EAAF,CAAK,SAAL,EAAgB,UAACC,OAAD,EAAa;AACzB,sBAAKX,eAAL,CAAqBW,OAArB;AACH,aAFD;AAGA,iBAAKT,OAAL,CAAaU,IAAb,CAAkBJ,CAAlB;AACH;;;sCAEaG,O,EAAS;AACnBE,oBAAQC,GAAR,CAAY,mBAAmBtB,QAAQuB,GAAvC;AACH;;;wCAEeJ,O,EAAS;AACrB,iBAAKK,MAAL,CAAYjB,IAAZ,CAAiBY,OAAjB;AACH;;;wCAEc;AAAA;;AACXnB,oBAAQkB,EAAR,CAAW,SAAX,EAAsB,UAACC,OAAD,EAAa;AAC/B,uBAAKM,aAAL,CAAmBN,OAAnB;AACH,aAFD;;AAIAhB,oBAAQe,EAAR,CAAW,MAAX,EAAmB,UAACQ,MAAD,EAASC,IAAT,EAAeC,MAAf,EAA0B;AACzC,oBAAIF,OAAOG,qBAAP,KAAiC,KAArC,EAA4C;AACxC,2BAAKd,YAAL;AACH;AACJ,aAJD;;AAMA,iBAAKe,IAAL,GAAY,oBAAZ;AACA,iBAAKA,IAAL,CAAUC,cAAV;;AAEA,gBAAMC,OAAO,0BAAb;AACAA,iBAAKC,YAAL;AACAD,iBAAKE,MAAL,CAAY,IAAZ,EAAkB9B,MAAM+B,eAAxB;;AAEA,iBAAKX,MAAL,GAAc,8BAAoBQ,KAAKI,MAAL,EAApB,EAAmCJ,KAAKK,SAAL,EAAnC,CAAd;AACA,iBAAKb,MAAL,CAAYc,WAAZ;;AAEA,mBAAON,IAAP;AACH;;;8BAEK;AACF,gBAAMA,OAAO,0BAAb;AACAA,iBAAKC,YAAL;AACAD,iBAAKE,MAAL,CAAY,IAAZ,EAAkB9B,MAAMmC,iBAAxB;AACH;;;;;;AAGL,IAAIlC,MAAJ,CAAWV,OAAX,EAAoBI,KAApB","file":"Server.js","sourcesContent":["import Ssdp from './Ssdp';\nimport RestServer from './RestServer';\nimport WebSocketServer from './WebSocketServer';\nconst numCPUs = require('os').cpus().length;\nconst debug = process.execArgv.indexOf('--debug') > -1 || process.execArgv.indexOf('--debug-brk') > -1;\nconst cluster = require('cluster');\nconst pjson = require('../../package.json');\n\nclass Server {\n\n    send(data){\n        if(!this.debug) {\n            process.send(data);\n        }else{\n            this.onWorkerMessage(data);\n        }\n    }\n\n    constructor(numWorker: Number, debug: boolean) {\n        this.debug = debug;\n        this.workers = [];\n\n        if(debug){\n            this.runMainWorker();\n            this.run();\n        }else if(cluster.isMaster){\n            this.runMainWorker();\n\n            for (let i = 0; i < numWorker; i++) {\n                this.createWorker();\n            }\n        } else {\n            this.run();\n        }\n    }\n\n    createWorker(){\n        let w = cluster.fork();\n        w.on('message', (message) => {\n            this.onWorkerMessage(message);\n        });\n        this.workers.push(w);\n    }\n\n    onMainMessage(message) {\n        console.log(\"Main Message: \" + process.pid);\n    }\n\n    onWorkerMessage(message) {\n        this.socket.send(message);\n    }\n\n    runMainWorker(){\n        process.on('message', (message) => {\n            this.onMainMessage(message);\n        });\n\n        cluster.on('exit', (worker, code, signal) => {\n            if (worker.exitedAfterDisconnect === false) {\n                this.createWorker();\n            }\n        });\n\n        this.upnp = new Ssdp();\n        this.upnp.startBroadcast();\n\n        const rest = new RestServer();\n        rest.createServer();\n        rest.listen(this, pjson.builder_ws_port);\n\n        this.socket = new WebSocketServer(rest.getLog(), rest.getServer());\n        this.socket.startServer();\n\n        return rest;\n    }\n\n    run() {\n        const rest = new RestServer();\n        rest.createServer();\n        rest.listen(this, pjson.builder_rest_port);\n    }\n}\n\nnew Server(numCPUs, debug);\n\n\n\n\n"]}