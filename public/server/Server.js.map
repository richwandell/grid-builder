{"version":3,"sources":["../../src/server/Server.es6"],"names":["numCPUs","require","cpus","length","debug","process","execArgv","indexOf","cluster","pjson","Server","data","send","onWorkerMessage","numWorker","workers","isMaster","runMainWorker","i","w","fork","on","message","push","run","console","log","pid","socket","onMainMessage","upnp","startBroadcast","rest","createServer","listen","builder_ws_port","getLog","getServer","startServer","builder_rest_port"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;;;;;AACA,IAAMA,UAAUC,QAAQ,IAAR,EAAcC,IAAd,GAAqBC,MAArC;AACA,IAAMC,QAAQC,QAAQC,QAAR,CAAiBC,OAAjB,CAAyB,SAAzB,IAAsC,CAAC,CAAvC,IAA4CF,QAAQC,QAAR,CAAiBC,OAAjB,CAAyB,aAAzB,IAA0C,CAAC,CAArG;AACA,IAAMC,UAAUP,QAAQ,SAAR,CAAhB;AACA,IAAMQ,QAAQR,QAAQ,oBAAR,CAAd;;IAEMS,M;;;6BAEGC,I,EAAK;AACN,gBAAG,CAAC,KAAKP,KAAT,EAAgB;AACZC,wBAAQO,IAAR,CAAaD,IAAb;AACH,aAFD,MAEK;AACD,qBAAKE,eAAL,CAAqBF,IAArB;AACH;AACJ;;;AAED,oBAAYG,SAAZ,EAA+BV,KAA/B,EAA+C;AAAA;;AAAA;;AAC3C,aAAKA,KAAL,GAAaA,KAAb;AACA,aAAKW,OAAL,GAAe,EAAf;AACA,YAAIP,QAAQQ,QAAR,IAAoB,CAACZ,KAAzB,EAAgC;AAC5B,iBAAKa,aAAL;;AAEA,iBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIJ,SAApB,EAA+BI,GAA/B,EAAoC;AAChC,oBAAIC,IAAIX,QAAQY,IAAR,EAAR;;AAEAD,kBAAEE,EAAF,CAAK,SAAL,EAAgB,UAACC,OAAD,EAAa;AACzB,0BAAKT,eAAL,CAAqBS,OAArB;AACH,iBAFD;;AAIA,qBAAKP,OAAL,CAAaQ,IAAb,CAAkBJ,CAAlB;AACH;AACJ,SAZD,MAYK;AACD,iBAAKK,GAAL;AACH;AACJ;;;;sCAEaF,O,EAAS;AACnBG,oBAAQC,GAAR,CAAY,mBAAmBrB,QAAQsB,GAAvC;AACH;;;wCAEeL,O,EAAS;AACrB,iBAAKM,MAAL,CAAYhB,IAAZ,CAAiBU,OAAjB;AACH;;;wCAEc;AAAA;;AACXjB,oBAAQgB,EAAR,CAAW,SAAX,EAAsB,UAACC,OAAD,EAAa;AAC/B,uBAAKO,aAAL,CAAmBP,OAAnB;AACH,aAFD;;AAIA,iBAAKQ,IAAL,GAAY,oBAAZ;AACA,iBAAKA,IAAL,CAAUC,cAAV;;AAEA,gBAAMC,OAAO,0BAAb;AACAA,iBAAKC,YAAL;AACAD,iBAAKE,MAAL,CAAY,IAAZ,EAAkBzB,MAAM0B,eAAxB;;AAEA,iBAAKP,MAAL,GAAc,8BAAoBI,KAAKI,MAAL,EAApB,EAAmCJ,KAAKK,SAAL,EAAnC,CAAd;AACA,iBAAKT,MAAL,CAAYU,WAAZ;;AAEA,mBAAON,IAAP;AACH;;;8BAEK;AACF,gBAAMA,OAAO,0BAAb;AACAA,iBAAKC,YAAL;AACAD,iBAAKE,MAAL,CAAY,IAAZ,EAAkBzB,MAAM8B,iBAAxB;AACH;;;;;;AAGL,IAAI7B,MAAJ,CAAWV,OAAX,EAAoBI,KAApB","file":"Server.js","sourcesContent":["import Ssdp from './Ssdp';\nimport RestServer from './RestServer';\nimport WebSocketServer from './WebSocketServer';\nconst numCPUs = require('os').cpus().length;\nconst debug = process.execArgv.indexOf('--debug') > -1 || process.execArgv.indexOf('--debug-brk') > -1;\nconst cluster = require('cluster');\nconst pjson = require('../../package.json');\n\nclass Server {\n\n    send(data){\n        if(!this.debug) {\n            process.send(data);\n        }else{\n            this.onWorkerMessage(data);\n        }\n    }\n\n    constructor(numWorker: Number, debug: boolean) {\n        this.debug = debug;\n        this.workers = [];\n        if (cluster.isMaster && !debug) {\n            this.runMainWorker();\n\n            for (let i = 0; i < numWorker; i++) {\n                let w = cluster.fork();\n\n                w.on('message', (message) => {\n                    this.onWorkerMessage(message);\n                });\n\n                this.workers.push(w);\n            }\n        }else{\n            this.run();\n        }\n    }\n\n    onMainMessage(message) {\n        console.log(\"Main Message: \" + process.pid);\n    }\n\n    onWorkerMessage(message) {\n        this.socket.send(message);\n    }\n\n    runMainWorker(){\n        process.on('message', (message) => {\n            this.onMainMessage(message);\n        });\n\n        this.upnp = new Ssdp();\n        this.upnp.startBroadcast();\n\n        const rest = new RestServer();\n        rest.createServer();\n        rest.listen(this, pjson.builder_ws_port);\n\n        this.socket = new WebSocketServer(rest.getLog(), rest.getServer());\n        this.socket.startServer();\n\n        return rest;\n    }\n\n    run() {\n        const rest = new RestServer();\n        rest.createServer();\n        rest.listen(this, pjson.builder_rest_port);\n    }\n}\n\nnew Server(numCPUs, debug);\n\n\n\n\n"]}