{"version":3,"sources":["../../src/server/RestServer.es6"],"names":["express","require","bodyParser","Utils","http","fs","RestServer","server","worker","id","log","db","app","use","json","limit","urlencoded","extended","static","req","res","data","body","cleanData","error","setResponseHeaders","layout_images","length","updateDatabase","err","rows","send","success","readFile","file","header","status","replace","getServerIp","getFloorPlans","forEach","row","layout_image","JSON","parse","params","getScannedCoords","fp_id","payload","undefined","message","saveReadings","notifyListeners","action","getLayoutInfo","stateParticles","particles","pf","setParticles","trackingLog","debug","ap_ids","f","features","makeFeatures","move","allParticles","getParticles","getParticleCoords","unique","getUniqueParticles","args","km","slice","largestCluster","getLargestClusterIndex","guess","getCentroid","clusters","getClusters","device_id","createFeaturesCache","then","moveParticles","makeKMeans","type","neighbors","all_particles","next","post","jsonHeaders","runLocalizer","localize","get","getDeviceDescription","sendFile","process","cwd","getFloorplans","createServer","port","listen"],"mappings":"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","file":"RestServer.js","sourcesContent":["import Knn from './Knn';\nimport KMeans from './KMeans';\nimport ParticleFilter from './ParticleFilter';\nimport Features from './Features';\n\nconst express = require('express');\nconst bodyParser = require('body-parser');\nconst Utils = require('./Utils.js');\nconst http = require('http');\nconst fs = require(\"fs\");\n\n\n/**\n * RestServer class is used to power the rest server that will communicate with the\n * mobile phone on the local wifi network. This server will respond to upnp devices\n * with the device description xml file as well as handle all saving and fetching of data.\n *\n * The rest server uses express.js and listens on a port configured by builder_rest_port\n * parameter in the package.json file within the public folder\n *\n * @author Rich Wandell <richwandell@gmail.com>\n */\nclass RestServer{\n\n    constructor(server: Server){\n        this.worker = server;\n        this.id = server.id;\n        this.log = server.log;\n        this.db = server.db;\n\n        this.app = express();\n        this.app.use(bodyParser.json({limit: '50mb'}));\n        this.app.use(bodyParser.urlencoded({ extended: true, limit: '50mb' }));\n        this.app.use('/builder', express.static('builder'))\n    }\n\n    /**\n     * Save handler for saving layout images from the UI\n     * @param req\n     * @param res\n     */\n    updateDatabase(req, res){\n        let log = this.log;\n        let db = this.db;\n        const data = req.body;\n        let cleanData = {};\n        let error = false;\n\n        log.log(\"/rest/updateDatabase\");\n        this.setResponseHeaders(res);\n\n        if(typeof(data.layout_images) != \"undefined\"){\n            if(data.layout_images.length > 0){\n                cleanData.layout_images = data.layout_images;\n            }else{\n                error = true;\n            }\n        }else{\n            error = true;\n        }\n\n        if(!error){\n            db.updateDatabase(cleanData, function(err, rows){\n                res.send({success: true});\n            });\n        }else{\n            res.send({success: false});\n        }\n\n        log.log(req.body);\n    }\n\n    /**\n     * Returns the device description xml file for upnp readers\n     * @param req\n     * @param res\n     */\n    getDeviceDescription(req, res){\n        let log = this.log;\n        let id = this.id;\n        fs.readFile('devicedescription.xml', \"binary\", function (err, file) {\n            if (err) {\n                res.header(\"Content-Type\", \"text/plain\");\n                res.status(500).send(err);\n                return;\n            }\n            file = file.replace(/\\{\\{UDN\\}\\}/, \"uuid:\" + id);\n            file = file.replace(/\\{\\{END\\}\\}/, \"http://\" + Utils.getServerIp() + \":8888/rest/\");\n            res.header(\"Access-Control-Allow-Origin\", \"*\");\n            res.header(\"Content-Type\", \"text/xml\");\n            res.send(file);\n        });\n    }\n\n    /**\n     * Returns all of the layout image records as a json array\n     * @param req\n     * @param res\n     */\n    getFloorplans(req, res){\n        let log = this.log;\n        let db = this.db;\n        log.log(\"/rest/floorplans\");\n        db.getFloorPlans(function(err, rows){\n            rows.forEach(function(row){\n                if(typeof(row.layout_image) != \"undefined\"){\n                    row.layout_image = JSON.parse(row.layout_image);\n                }\n            });\n            res.send(rows);\n        });\n    }\n\n    getScannedCoords(req, res){\n        let log = this.log;\n        let db = this.db;\n        const data = req.params;\n        log.log(\"/rest/getScannedCoords\");\n        db.getScannedCoords(data.fp_id, function(err, rows){\n            res.send(rows);\n        });\n    }\n\n    saveReadings(req, res){\n        let log = this.log;\n        log.log(\"/rest/saveReadings\");\n        const data = req.body;\n        log.log(data);\n        if(data.payload === undefined){\n            return res.send({success: false, message: \"missing payload\"});\n        }\n        this.db.saveReadings(data.payload, (fp_id) => {\n            res.send({success: true});\n            this.notifyListeners({\n                action: 'NEW_READING',\n                fp_id: fp_id\n            });\n        });\n\n    }\n\n    runLocalizer(req, res) {\n        const fp_id = data.fp_id;\n    }\n\n    getLayoutInfo(req, res){\n        let log = this.log;\n        log.log(\"/rest/layout_info/all\");\n        this.setResponseHeaders(res);\n\n        this.db.getLayoutInfo(function(err, rows){\n            res.send({\n                success: true,\n                payload: rows\n            });\n        });\n    }\n\n    setResponseHeaders(res){\n        res.header(\"Access-Control-Allow-Origin\", \"*\");\n        res.header('Content-Type', 'application/javascript');\n        res.header(\"Cache-Control\", \"no-cache\");\n    }\n\n    moveParticles(data, id) {\n        let stateParticles = [];\n        if (this.worker.particles[id] !== undefined) {\n            stateParticles = this.worker.particles[id];\n        }\n        let pf = new ParticleFilter(this.db, data.fp_id);\n        pf.setParticles(stateParticles);\n        this.worker.trackingLog.debug(data.ap_ids);\n\n        const f = new Features();\n        const features = f.makeFeatures(data.ap_ids);\n        pf.move(features);\n        const allParticles = pf.getParticles();\n        this.worker.particles[id] = allParticles;\n\n        const particles = pf.getParticleCoords();\n        const unique = pf.getUniqueParticles();\n        return [particles, unique, allParticles]\n    }\n\n    makeKMeans(args) {\n        let [particles, unique, allParticles] = args;\n        let km = new KMeans(2, unique.slice(0, 5));\n        const largestCluster = km.getLargestClusterIndex();\n        const guess = km.getCentroid(largestCluster);\n        const clusters = km.getClusters();\n\n        return [particles, unique, clusters, guess, allParticles];\n    }\n\n    localize(req, res) {\n        this.log.log(\"/rest/localize\");\n        const data = req.body;\n        const id = data.device_id;\n        const fp_id = data.fp_id;\n\n        this.db.createFeaturesCache(fp_id)\n            .then(() => this.moveParticles(data, id))\n            .then(this.makeKMeans)\n            .then((args) => {\n                let [particles, unique, clusters, guess, allParticles] = args;\n                res.send({\n                    success: true,\n                    id: id,\n                    guess: guess,\n                    type: data.type,\n                    particles: particles,\n                    neighbors: unique,\n                    clusters: clusters\n                });\n                this.notifyListeners({\n                    action: 'LOCALIZE',\n                    id: id,\n                    guess: guess,\n                    type: data.type,\n                    particles: particles,\n                    neighbors: unique,\n                    clusters: clusters,\n                    fp_id: data.fp_id,\n                    all_particles: allParticles\n                });\n            }\n        );\n    }\n\n    notifyListeners(data: Object) {\n        this.worker.send(data);\n    }\n\n    jsonHeaders(req, res, next){\n        res.header(\"Access-Control-Allow-Origin\", \"*\");\n        res.header('Content-Type', 'application/javascript');\n        res.header(\"Cache-Control\", \"no-cache\");\n        next();\n    }\n\n    /**\n     * Routes are defined here and mapped to actions\n     */\n    createServer() {\n        const app = this.app;\n\n        app.post('/rest/runLocalizer', this.jsonHeaders, (req, res) => {\n            this.runLocalizer(req, res);\n        });\n\n        app.post('/rest/localize', this.jsonHeaders, (req, res) => {\n            this.localize(req, res);\n        });\n\n        app.get('/rest/alive', this.jsonHeaders, (req, res) => {\n            res.send({success: true});\n        });\n\n        app.post('/rest/updateDatabase', (req, res) => {\n            this.updateDatabase(req, res);\n        });\n\n        app.get('/devicedescription.xml', (req, res) => {\n            this.getDeviceDescription(req, res);\n        });\n\n        app.get(\"/icon24.png\", (req, res) => {\n            this.log.log(\"icon24.png\");\n            res.header(\"Access-Control-Allow-Origin\", \"*\");\n            res.sendFile(process.cwd() + '/src/icon24.png');\n        });\n\n        app.get(\"/rest/floorplans\", this.jsonHeaders, (req, res) => {\n            this.getFloorplans(req, res);\n        });\n\n        app.post(\"/rest/saveReadings\", this.jsonHeaders, (req, res) => {\n            this.saveReadings(req, res);\n        });\n\n        app.get(\"/rest/getScannedCoords/:fp_id\", this.jsonHeaders, (req, res) => {\n            this.getScannedCoords(req, res);\n        });\n\n        this.server = http.createServer(app);\n\n    }\n\n    listen(port){\n        this.server.listen(port);\n    }\n\n    getApp(): express {\n        return this.app;\n    }\n\n    getServer(): Server {\n        return this.server\n    }\n\n    getLog(): Log {\n        return this.log;\n    }\n}\n\n\nexport default RestServer;"]}